{% include base_path %}

{% if page.author_profile or layout.author_profile or page.sidebar or page.toc or page.filter %}
  <div class="sidebar sticky">
  {% if page.author_profile or layout.author_profile %}{% include author-profile.html %}{% endif %}
  {% if page.sidebar %}
    {% for s in page.sidebar %}
      {% if s.image %}
        <img src=
        {% if s.image contains "://" %}
          "{{ s.image }}"
        {% else %}
          "{{ s.image | prepend: "/images/" | prepend: base_path }}"
        {% endif %}
        alt="{% if s.image_alt %}{{ s.image_alt }}{% endif %}">
      {% endif %}
      {% if s.title %}<h3>{{ s.title }}</h3>{% endif %}
      {% if s.text %}{{ s.text | markdownify }}{% endif %}
    {% endfor %}
    {% if page.sidebar.nav %}
      {% include nav_list nav=page.sidebar.nav %}
    {% endif %}
  {% endif %}

  <!-- 标签筛选区域 -->
  {% if page.filter %}
    <div class="sidebar-filter-wrapper">
      <div class="filter-section">
        <div class="filter-header">
          <h2 class="nav__title"> <i class="fa fa-filter"></i> News filters </h2>
          <button id="clear-filter" class="clear-filter-btn">  Clear </button>    
        </div>
        <div id="tag-filter" class="tag-filter-container">
          {% assign all_tags = site.posts | map: "tags" | join: "," | split: "," | uniq | sort_natural %}
          {%- assign ordered_groups = "Group,Topic,Method,Output" | split: "," -%}
          {%- assign used_tags = "" | split: "," -%}
          {%- for g in ordered_groups -%}
            {%- assign group_tags = "" | split: "," -%}
            {%- for tag in all_tags -%}
              {%- if tag contains g | append: ":" -%}
                {%- assign group_tags = group_tags | push: tag -%}
                {%- assign used_tags = used_tags | push: tag -%}
              {%- endif -%}
            {%- endfor -%}
            {%- if group_tags.size > 0 -%}
              <div class="tag-group">
                {%- unless g == "Group" -%}
                  <h4>{{ g }}</h4>
                {%- endunless -%}
                <div class="tag-values">
                  {%- for t in group_tags -%}
                    {%- assign name = t | remove_first: g | remove_first: ":" | strip -%}
                    <span class="tag-value"
                          data-full-tag="{{ t }}">
                      {%- if g == "Group" -%}
                        {{ name }}
                      {%- else -%}
                        {{ g }}: {{ name }}
                      {%- endif -%}
                    </span>
                  {%- endfor -%}
                </div>
              </div>
            {%- endif -%}
          {%- endfor -%}
          {%- assign others = "" | split: "," -%}
          {%- for tag in all_tags -%}
            {%- unless used_tags contains tag -%}
              {%- assign others = others | push: tag -%}
            {%- endunless -%}
          {%- endfor -%}
          {%- if others.size > 0 -%}
            <div class="tag-group">
              <h4>Others</h4>
              <div class="tag-values">
                {%- for tag in others -%}
                  <span class="tag-value"
                        data-full-tag="{{ tag }}">
                    {{ tag }}
                  </span>
                {%- endfor -%}
              </div>
            </div>
          {%- endif -%}
        </div>
      </div>
    </div>
  {% endif %}

  {% if page.toc %}
    {% include toc content=content title="Contents" %}
  {% endif %}

  </div>
{% endif %}
